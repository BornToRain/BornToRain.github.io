{"title":"从零开始撸框架(2)-项目龙骨","uid":"1f961444d2b8322d4f975faeb98fbea1","slug":"从零开始撸框架(2)-项目龙骨","date":"2021-04-29T02:03:09.000Z","updated":"2021-06-21T14:00:35.153Z","comments":true,"path":"api/articles/从零开始撸框架(2)-项目龙骨.json","keywords":["Coder","Scalaer","Javaer"],"cover":"/images/vertxlogo.png","content":"<h2 id=\"项目结构\"><a href=\"#项目结构\" class=\"headerlink\" title=\"项目结构\"></a>项目结构</h2><p>上文说到框架包含Ioc、Di、Orm、Cache等功能,其中只有前两者为核心功能.那么结构上可以采用分包结构开发,即分为核心、组件等功能包,如下.</p>\n<ul>\n<li>org.btr.ygo.core 核心包,包含了框架ioc、di功能,为其他组件提供支持.</li>\n<li>org.btr.ygo.tp tp意为(third-party),可以将数据库、缓存等需要引入第三方jar的功能放到这.</li>\n<li>org.btr.ygo.web web功能</li>\n</ul>\n<p>接下来我们先完成core核心包的功能开发.</p>\n<hr>\n<h2 id=\"工厂\"><a href=\"#工厂\" class=\"headerlink\" title=\"工厂\"></a>工厂</h2><p>说到核心Ioc、Di自然离不开工厂模式.我们先准备写工厂会用到的jar</p>\n<p><strong>build.gradle</strong></p>\n<div class=\"language-txt\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">txt</span><pre class=\"shiki solarized-light\" style=\"background-color: #FDF6E3\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #657B83\">dependencies &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  // 高性能反射</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  compile &quot;com.esotericsoftware:reflectasm:1.11.9&quot;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  // vertx核心jar</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  compile &quot;io.vertx:vertx-core:$vertxVersion&quot;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">&#125;</span></span></code></pre></div><h3 id=\"辅助类\"><a href=\"#辅助类\" class=\"headerlink\" title=\"辅助类\"></a>辅助类</h3><p>类工厂会经常用到反射,我们需要写几个类来辅助工厂实现.</p>\n<p>函数类,这里会存放以后会用到的各种函数式方法.<br><strong>EnsureSuppliver.java</strong></p>\n<div class=\"language-java\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">java</span><pre class=\"shiki solarized-light\" style=\"background-color: #FDF6E3\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #859900\">package</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">org.btr.ygo.core.funtions</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\">/**</span></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\"> * java8的异常版本</span></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\"> * </span><span style=\"color: #859900; font-style: italic\">@see</span><span style=\"color: #93A1A1; font-style: italic\"> java.util.function.Supplier</span></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\"> * </span><span style=\"color: #859900; font-style: italic\">@author</span><span style=\"color: #93A1A1; font-style: italic\"> &lt;a href=&quot;mailto:1159930219@qq.com&quot;&gt;BornToRain&lt;/a&gt;</span></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\"> */</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">@</span><span style=\"color: #586E75; font-weight: bold\">FunctionalInterface</span></span>\n<span class=\"line\"><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">interface</span><span style=\"color: #657B83\"> </span><span style=\"color: #CB4B16\">EnsureSuppliver</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">T</span><span style=\"color: #657B83\">&gt; &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">T</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">get</span><span style=\"color: #657B83\">() </span><span style=\"color: #586E75; font-weight: bold\">throws</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">Exception</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">&#125;</span></span></code></pre></div><p><strong>EnsureExec.java</strong></p>\n<div class=\"language-java\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">java</span><pre class=\"shiki solarized-light\" style=\"background-color: #FDF6E3\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #859900\">package</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">org.btr.ygo.core.funtions</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\">/**</span></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\"> * java8的异常版本</span></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\"> * </span><span style=\"color: #859900; font-style: italic\">@see</span><span style=\"color: #93A1A1; font-style: italic\"> java.util.function.Consumer</span></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\"> * </span><span style=\"color: #859900; font-style: italic\">@author</span><span style=\"color: #93A1A1; font-style: italic\"> &lt;a href=&quot;mailto:1159930219@qq.com&quot;&gt;BornToRain&lt;/a&gt;</span></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\"> */</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">@</span><span style=\"color: #586E75; font-weight: bold\">FunctionalInterface</span></span>\n<span class=\"line\"><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">interface</span><span style=\"color: #657B83\"> </span><span style=\"color: #CB4B16\">EnsureExec</span><span style=\"color: #657B83\"> &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">void</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">exec</span><span style=\"color: #657B83\">() </span><span style=\"color: #586E75; font-weight: bold\">throws</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">Exception</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">&#125;</span></span></code></pre></div><p><strong>Fn.java</strong></p>\n<div class=\"language-java\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">java</span><pre class=\"shiki solarized-light\" style=\"background-color: #FDF6E3\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #859900\">package</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">org.btr.ygo.core.kit</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">lombok.extern.log4j.Log4j2</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">org.btr.ygo.core.funtions.EnsureExec</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">org.btr.ygo.core.funtions.EnsureSuppliver</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">java.util.Arrays</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">java.util.Map</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">java.util.Objects</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">java.util.function.Supplier</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\">/**</span></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\"> * 函数类,封装了条件分支以及非空判断.</span></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\"> * </span><span style=\"color: #859900; font-style: italic\">@author</span><span style=\"color: #93A1A1; font-style: italic\"> &lt;a href=&quot;mailto:1159930219@qq.com&quot;&gt;BornToRain&lt;/a&gt;</span></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\"> */</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">@</span><span style=\"color: #586E75; font-weight: bold\">Log4j2</span></span>\n<span class=\"line\"><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">final</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">class</span><span style=\"color: #657B83\"> </span><span style=\"color: #CB4B16\">Fn</span><span style=\"color: #657B83\"> &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #93A1A1; font-style: italic\">// 连接池函数,优先使用key在池中找可用value,找不到才会通过Supplier去创建一个value.</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">static</span><span style=\"color: #657B83\"> &lt;</span><span style=\"color: #586E75; font-weight: bold\">K</span><span style=\"color: #657B83\">, </span><span style=\"color: #586E75; font-weight: bold\">V</span><span style=\"color: #657B83\">&gt; </span><span style=\"color: #586E75; font-weight: bold\">V</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">pool</span><span style=\"color: #657B83\">(</span><span style=\"color: #586E75; font-weight: bold\">Map</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">K</span><span style=\"color: #657B83\">, </span><span style=\"color: #586E75; font-weight: bold\">V</span><span style=\"color: #657B83\">&gt; map, </span><span style=\"color: #586E75; font-weight: bold\">K</span><span style=\"color: #657B83\"> key, </span><span style=\"color: #586E75; font-weight: bold\">Supplier</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">V</span><span style=\"color: #657B83\">&gt; fn) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #586E75; font-weight: bold\">V</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">value</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">map</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">get</span><span style=\"color: #657B83\">(key);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #859900\">if</span><span style=\"color: #657B83\"> (</span><span style=\"color: #268BD2\">Objects</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">isNull</span><span style=\"color: #657B83\">(value)) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      value </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">fn</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">get</span><span style=\"color: #657B83\">();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #268BD2\">map</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">put</span><span style=\"color: #657B83\">(key, value);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #859900\">return</span><span style=\"color: #657B83\"> value;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">static</span><span style=\"color: #657B83\"> &lt;</span><span style=\"color: #586E75; font-weight: bold\">T</span><span style=\"color: #657B83\">&gt; </span><span style=\"color: #586E75; font-weight: bold\">T</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">ensureRun</span><span style=\"color: #657B83\">(</span><span style=\"color: #586E75; font-weight: bold\">EnsureSuppliver</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">T</span><span style=\"color: #657B83\">&gt; fn, </span><span style=\"color: #586E75; font-weight: bold\">Object</span><span style=\"color: #657B83\">... args) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #859900\">return</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">ensureRun</span><span style=\"color: #657B83\">(</span><span style=\"color: #B58900\">null</span><span style=\"color: #657B83\">, fn, args);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">static</span><span style=\"color: #657B83\"> &lt;</span><span style=\"color: #586E75; font-weight: bold\">T</span><span style=\"color: #657B83\">&gt; </span><span style=\"color: #586E75; font-weight: bold\">T</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">ensureRun</span><span style=\"color: #657B83\">(</span><span style=\"color: #586E75; font-weight: bold\">T</span><span style=\"color: #657B83\"> defaultValue, </span><span style=\"color: #586E75; font-weight: bold\">EnsureSuppliver</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">T</span><span style=\"color: #657B83\">&gt; fn, </span><span style=\"color: #586E75; font-weight: bold\">Object</span><span style=\"color: #657B83\">... args) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #586E75; font-weight: bold\">T</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">ret</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #B58900\">null</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #859900\">try</span><span style=\"color: #657B83\"> &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #859900\">if</span><span style=\"color: #657B83\"> (</span><span style=\"color: #268BD2\">Arrays</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">stream</span><span style=\"color: #657B83\">(args).</span><span style=\"color: #268BD2\">allMatch</span><span style=\"color: #657B83\">(Objects</span><span style=\"color: #859900\">::</span><span style=\"color: #657B83\">nonNull)) ret </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">fn</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">get</span><span style=\"color: #657B83\">();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    &#125; </span><span style=\"color: #859900\">catch</span><span style=\"color: #657B83\"> (</span><span style=\"color: #586E75; font-weight: bold\">Exception</span><span style=\"color: #657B83\"> e) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #268BD2\">e</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">printStackTrace</span><span style=\"color: #657B83\">();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    &#125; </span><span style=\"color: #859900\">finally</span><span style=\"color: #657B83\"> &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #859900\">if</span><span style=\"color: #657B83\"> (</span><span style=\"color: #268BD2\">Objects</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">isNull</span><span style=\"color: #657B83\">(ret)) ret </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> defaultValue;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #859900\">return</span><span style=\"color: #657B83\"> ret;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">static</span><span style=\"color: #657B83\"> &lt;</span><span style=\"color: #586E75; font-weight: bold\">T</span><span style=\"color: #657B83\">&gt; </span><span style=\"color: #586E75; font-weight: bold\">T</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">ensureRun</span><span style=\"color: #657B83\">(</span><span style=\"color: #586E75; font-weight: bold\">boolean</span><span style=\"color: #657B83\"> condition, </span><span style=\"color: #586E75; font-weight: bold\">EnsureSuppliver</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">T</span><span style=\"color: #657B83\">&gt; fn1, </span><span style=\"color: #586E75; font-weight: bold\">EnsureSuppliver</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">T</span><span style=\"color: #657B83\">&gt; fn2) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #586E75; font-weight: bold\">T</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">ret</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #B58900\">null</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #859900\">try</span><span style=\"color: #657B83\"> &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #859900\">if</span><span style=\"color: #657B83\"> (condition </span><span style=\"color: #859900\">&amp;&amp;</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">Objects</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">nonNull</span><span style=\"color: #657B83\">(fn1)) ret </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">fn1</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">get</span><span style=\"color: #657B83\">();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #859900\">else</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">if</span><span style=\"color: #657B83\"> (</span><span style=\"color: #859900\">!</span><span style=\"color: #657B83\">condition </span><span style=\"color: #859900\">&amp;&amp;</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">Objects</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">nonNull</span><span style=\"color: #657B83\">(fn2)) ret </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">fn2</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">get</span><span style=\"color: #657B83\">();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    &#125; </span><span style=\"color: #859900\">catch</span><span style=\"color: #657B83\"> (</span><span style=\"color: #586E75; font-weight: bold\">Exception</span><span style=\"color: #657B83\"> e) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #268BD2\">e</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">printStackTrace</span><span style=\"color: #657B83\">();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #859900\">return</span><span style=\"color: #657B83\"> ret;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">static</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">void</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">ensureExec</span><span style=\"color: #657B83\">(</span><span style=\"color: #586E75; font-weight: bold\">EnsureExec</span><span style=\"color: #657B83\"> fn, </span><span style=\"color: #586E75; font-weight: bold\">Object</span><span style=\"color: #657B83\">... args) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #859900\">try</span><span style=\"color: #657B83\"> &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #859900\">if</span><span style=\"color: #657B83\"> (</span><span style=\"color: #268BD2\">Arrays</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">stream</span><span style=\"color: #657B83\">(args).</span><span style=\"color: #268BD2\">allMatch</span><span style=\"color: #657B83\">(Objects</span><span style=\"color: #859900\">::</span><span style=\"color: #657B83\">nonNull)) </span><span style=\"color: #268BD2\">fn</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">exec</span><span style=\"color: #657B83\">();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    &#125; </span><span style=\"color: #859900\">catch</span><span style=\"color: #657B83\"> (</span><span style=\"color: #586E75; font-weight: bold\">Exception</span><span style=\"color: #657B83\"> ex) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #268BD2\">ex</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">printStackTrace</span><span style=\"color: #657B83\">();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">static</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">void</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">ensureExec</span><span style=\"color: #657B83\">(</span><span style=\"color: #586E75; font-weight: bold\">boolean</span><span style=\"color: #657B83\"> condition, </span><span style=\"color: #586E75; font-weight: bold\">EnsureExec</span><span style=\"color: #657B83\"> fn1) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #268BD2\">ensureExec</span><span style=\"color: #657B83\">(condition, fn1, </span><span style=\"color: #B58900\">null</span><span style=\"color: #657B83\">);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">static</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">void</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">ensureExec</span><span style=\"color: #657B83\">(</span><span style=\"color: #586E75; font-weight: bold\">boolean</span><span style=\"color: #657B83\"> condition, </span><span style=\"color: #586E75; font-weight: bold\">EnsureExec</span><span style=\"color: #657B83\"> fn1, </span><span style=\"color: #586E75; font-weight: bold\">EnsureExec</span><span style=\"color: #657B83\"> fn2) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #859900\">try</span><span style=\"color: #657B83\"> &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #859900\">if</span><span style=\"color: #657B83\"> (condition </span><span style=\"color: #859900\">&amp;&amp;</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">Objects</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">nonNull</span><span style=\"color: #657B83\">(fn1)) </span><span style=\"color: #268BD2\">fn1</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">exec</span><span style=\"color: #657B83\">();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #859900\">else</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">if</span><span style=\"color: #657B83\"> (</span><span style=\"color: #859900\">!</span><span style=\"color: #657B83\">condition </span><span style=\"color: #859900\">&amp;&amp;</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">Objects</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">nonNull</span><span style=\"color: #657B83\">(fn2)) </span><span style=\"color: #268BD2\">fn2</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">exec</span><span style=\"color: #657B83\">();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    &#125; </span><span style=\"color: #859900\">catch</span><span style=\"color: #657B83\"> (</span><span style=\"color: #586E75; font-weight: bold\">Exception</span><span style=\"color: #657B83\"> ex) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #268BD2\">ex</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">printStackTrace</span><span style=\"color: #657B83\">();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">static</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">String</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">join</span><span style=\"color: #657B83\">(</span><span style=\"color: #586E75; font-weight: bold\">CharSequence</span><span style=\"color: #657B83\"> delimiter, </span><span style=\"color: #586E75; font-weight: bold\">Object</span><span style=\"color: #657B83\">... param) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #859900\">return</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">Fn</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">ensureRun</span><span style=\"color: #657B83\">(</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      () </span><span style=\"color: #586E75; font-weight: bold\">-&gt;</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">Arrays</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">stream</span><span style=\"color: #657B83\">(param).</span><span style=\"color: #268BD2\">map</span><span style=\"color: #657B83\">(Objects</span><span style=\"color: #859900\">::</span><span style=\"color: #657B83\">toString).</span><span style=\"color: #268BD2\">collect</span><span style=\"color: #657B83\">(</span><span style=\"color: #268BD2\">Collectors</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">joining</span><span style=\"color: #657B83\">(delimiter)),</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      delimiter, param);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">&#125;</span></span></code></pre></div><p>反射类,有关反射的方法都放在这.<br><strong>Reflect.java</strong></p>\n<div class=\"language-java\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">java</span><pre class=\"shiki solarized-light\" style=\"background-color: #FDF6E3\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #859900\">package</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">org.btr.ygo.core.kit</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">com.esotericsoftware.reflectasm.ConstructorAccess</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">lombok.extern.log4j.Log4j2</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">lombok.val</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">java.lang.reflect.Constructor</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">java.util.HashMap</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">java.util.Map</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\">/**</span></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\"> * </span><span style=\"color: #859900; font-style: italic\">@author</span><span style=\"color: #93A1A1; font-style: italic\"> &lt;a href=&quot;mailto:1159930219@qq.com&quot;&gt;BornToRain&lt;/a&gt;</span></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\"> */</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">@</span><span style=\"color: #586E75; font-weight: bold\">Log4j2</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">@</span><span style=\"color: #586E75; font-weight: bold\">SuppressWarnings</span><span style=\"color: #657B83\">(</span><span style=\"color: #2AA198\">&quot;all&quot;</span><span style=\"color: #657B83\">)</span></span>\n<span class=\"line\"><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">final</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">class</span><span style=\"color: #657B83\"> </span><span style=\"color: #CB4B16\">Reflect</span><span style=\"color: #657B83\"> &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #93A1A1; font-style: italic\">// reflectasm开销主要在于对象的获取,我们把它存起来.</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">private</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">static</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">final</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">Map</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">Class</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">?</span><span style=\"color: #657B83\">&gt;, </span><span style=\"color: #586E75; font-weight: bold\">ConstructorAccess</span><span style=\"color: #657B83\">&gt; </span><span style=\"color: #268BD2\">CONSTRUCTORS</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">new</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">HashMap</span><span style=\"color: #657B83\">&lt;&gt;();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">static</span><span style=\"color: #657B83\"> &lt;</span><span style=\"color: #586E75; font-weight: bold\">T</span><span style=\"color: #657B83\">&gt; </span><span style=\"color: #586E75; font-weight: bold\">T</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">constructor</span><span style=\"color: #657B83\">(</span><span style=\"color: #586E75; font-weight: bold\">Class</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">?</span><span style=\"color: #657B83\">&gt; cls, </span><span style=\"color: #586E75; font-weight: bold\">Object</span><span style=\"color: #657B83\">... args) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #586E75; font-weight: bold\">T</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">ret</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #B58900\">null</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #859900\">try</span><span style=\"color: #657B83\"> &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      val constructors </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">cls</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">getDeclaredConstructors</span><span style=\"color: #657B83\">();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #93A1A1; font-style: italic\">// 拿到类的所有构造函数,我们根据参数来判断选用何种方式创建对象.</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #93A1A1; font-style: italic\">// 优先使用无参,这样能调用到reflectasm.</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #93A1A1; font-style: italic\">// 无参不满足就只能走Java原生了.</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #859900\">for</span><span style=\"color: #657B83\"> (</span><span style=\"color: #586E75; font-weight: bold\">Constructor</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">?</span><span style=\"color: #657B83\">&gt; </span><span style=\"color: #268BD2\">constructor</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">:</span><span style=\"color: #657B83\"> constructors) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">        val size </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">args</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">length</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">        </span><span style=\"color: #859900\">if</span><span style=\"color: #657B83\"> (</span><span style=\"color: #D33682\">0</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">==</span><span style=\"color: #657B83\"> size) ret </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">noArgConstructor</span><span style=\"color: #657B83\">(cls);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">        </span><span style=\"color: #859900\">else</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">if</span><span style=\"color: #657B83\"> (size </span><span style=\"color: #859900\">!=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">constructor</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">getParameterTypes</span><span style=\"color: #657B83\">().</span><span style=\"color: #268BD2\">length</span><span style=\"color: #657B83\">) </span><span style=\"color: #859900\">continue</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">        ret </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> (T) </span><span style=\"color: #268BD2\">constructor</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">newInstance</span><span style=\"color: #657B83\">(args);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #859900\">return</span><span style=\"color: #657B83\"> ret;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    &#125; </span><span style=\"color: #859900\">catch</span><span style=\"color: #657B83\"> (</span><span style=\"color: #586E75; font-weight: bold\">Exception</span><span style=\"color: #657B83\"> e) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #268BD2\">e</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">printStackTrace</span><span style=\"color: #657B83\">();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #859900\">return</span><span style=\"color: #657B83\"> ret;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #93A1A1; font-style: italic\">// 这里用到了reflectasm高性能反射,缺点就是仅支持无参.</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">static</span><span style=\"color: #657B83\"> &lt;</span><span style=\"color: #586E75; font-weight: bold\">T</span><span style=\"color: #657B83\">&gt; </span><span style=\"color: #586E75; font-weight: bold\">T</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">noArgConstructor</span><span style=\"color: #657B83\">(</span><span style=\"color: #586E75; font-weight: bold\">Class</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">?</span><span style=\"color: #657B83\">&gt; cls) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    val access </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">Fn</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">pool</span><span style=\"color: #657B83\">(CONSTRUCTORS, cls, () </span><span style=\"color: #586E75; font-weight: bold\">-&gt;</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">ConstructorAccess</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">get</span><span style=\"color: #657B83\">(cls));</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #859900\">return</span><span style=\"color: #657B83\"> (T) </span><span style=\"color: #268BD2\">access</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">newInstance</span><span style=\"color: #657B83\">();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">&#125;</span></span></code></pre></div><h3 id=\"本体\"><a href=\"#本体\" class=\"headerlink\" title=\"本体\"></a>本体</h3><p><strong>Trunk.java</strong></p>\n<div class=\"language-java\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">java</span><pre class=\"shiki solarized-light\" style=\"background-color: #FDF6E3\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #859900\">package</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">org.btr.ygo.core.kit</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">lombok.extern.log4j.Log4j2</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">java.util.HashMap</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">java.util.Map</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\">/**</span></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\"> * </span><span style=\"color: #859900; font-style: italic\">@author</span><span style=\"color: #93A1A1; font-style: italic\"> &lt;a href=&quot;mailto:1159930219@qq.com&quot;&gt;BornToRain&lt;/a&gt;</span></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\"> */</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">@</span><span style=\"color: #586E75; font-weight: bold\">Log4j2</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">@</span><span style=\"color: #586E75; font-weight: bold\">SuppressWarnings</span><span style=\"color: #657B83\">(</span><span style=\"color: #2AA198\">&quot;unchecked&quot;</span><span style=\"color: #657B83\">)</span></span>\n<span class=\"line\"><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">final</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">class</span><span style=\"color: #657B83\"> </span><span style=\"color: #CB4B16\">Trunk</span><span style=\"color: #657B83\"> &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #93A1A1; font-style: italic\">// 单例存储所有类对象</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">private</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">static</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">final</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">Map</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">String</span><span style=\"color: #657B83\">, </span><span style=\"color: #586E75; font-weight: bold\">Object</span><span style=\"color: #657B83\">&gt; </span><span style=\"color: #268BD2\">SINGLETON</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">new</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">HashMap</span><span style=\"color: #657B83\">&lt;&gt;();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #93A1A1; font-style: italic\">// 所有扫描的类</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">static</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">final</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">Set</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">Class</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">?</span><span style=\"color: #657B83\">&gt;&gt; </span><span style=\"color: #268BD2\">CLASSES</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">new</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">HashSet</span><span style=\"color: #657B83\">&lt;&gt;();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #93A1A1; font-style: italic\">// 单例,优先读map对象,无则懒加载获取实例并存入map.</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">static</span><span style=\"color: #657B83\"> &lt;</span><span style=\"color: #586E75; font-weight: bold\">T</span><span style=\"color: #657B83\">&gt; </span><span style=\"color: #586E75; font-weight: bold\">T</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">singleton</span><span style=\"color: #657B83\">(</span><span style=\"color: #586E75; font-weight: bold\">Class</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">?</span><span style=\"color: #657B83\">&gt; cls, </span><span style=\"color: #586E75; font-weight: bold\">Object</span><span style=\"color: #657B83\">... args) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #859900\">return</span><span style=\"color: #657B83\"> (T) </span><span style=\"color: #268BD2\">Fn</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">pool</span><span style=\"color: #657B83\">(SINGLETON, </span><span style=\"color: #268BD2\">cls</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">getName</span><span style=\"color: #657B83\">(), () </span><span style=\"color: #586E75; font-weight: bold\">-&gt;</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">instance</span><span style=\"color: #657B83\">(cls, args));</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #93A1A1; font-style: italic\">// 实例,每调用一次产生一例.</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">static</span><span style=\"color: #657B83\"> &lt;</span><span style=\"color: #586E75; font-weight: bold\">T</span><span style=\"color: #657B83\">&gt; </span><span style=\"color: #586E75; font-weight: bold\">T</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">instance</span><span style=\"color: #657B83\">(</span><span style=\"color: #586E75; font-weight: bold\">Class</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">?</span><span style=\"color: #657B83\">&gt; cls, </span><span style=\"color: #586E75; font-weight: bold\">Object</span><span style=\"color: #657B83\">... args) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #859900\">return</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">Fn</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      .</span><span style=\"color: #268BD2\">ensureRun</span><span style=\"color: #657B83\">(</span><span style=\"color: #D33682\">0</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">==</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">args</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">length</span><span style=\"color: #657B83\">, () </span><span style=\"color: #586E75; font-weight: bold\">-&gt;</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">Reflect</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">noArgConstructor</span><span style=\"color: #657B83\">(cls), () </span><span style=\"color: #586E75; font-weight: bold\">-&gt;</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">Reflect</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">constructor</span><span style=\"color: #657B83\">(cls, args));</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">&#125;</span></span></code></pre></div><h3 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h3><p><strong>TrunkTest.java</strong></p>\n<div class=\"language-java\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">java</span><pre class=\"shiki solarized-light\" style=\"background-color: #FDF6E3\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #859900\">package</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">org.btr.ygo.core.kit</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">lombok.extern.log4j.Log4j2</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">lombok.val</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">org.btr.ygo.core.TestApi</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">org.junit.Assert</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">org.junit.Test</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\">/**</span></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\"> * </span><span style=\"color: #859900; font-style: italic\">@author</span><span style=\"color: #93A1A1; font-style: italic\"> &lt;a href=&quot;mailto:1159930219@qq.com&quot;&gt;BornToRain&lt;/a&gt;</span></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\"> */</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">@</span><span style=\"color: #586E75; font-weight: bold\">Log4j2</span></span>\n<span class=\"line\"><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">class</span><span style=\"color: #657B83\"> </span><span style=\"color: #CB4B16\">TrunkTest</span><span style=\"color: #657B83\"> &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  @</span><span style=\"color: #586E75; font-weight: bold\">Test</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">void</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">testInstance</span><span style=\"color: #657B83\">() &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    val i1 </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">Trunk</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">instance</span><span style=\"color: #657B83\">(</span><span style=\"color: #268BD2\">TestApi</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">class</span><span style=\"color: #657B83\">);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    val i2 </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">Trunk</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">instance</span><span style=\"color: #657B83\">(</span><span style=\"color: #268BD2\">TestApi</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">class</span><span style=\"color: #657B83\">);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #268BD2\">log</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">info</span><span style=\"color: #657B83\">(</span><span style=\"color: #2AA198\">&quot;i1: &#123;&#125;, i2: &#123;&#125;&quot;</span><span style=\"color: #657B83\">, i1, i2);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #268BD2\">Assert</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">assertNotEquals</span><span style=\"color: #657B83\">(i1, i2);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  @</span><span style=\"color: #586E75; font-weight: bold\">Test</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">void</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">testSingleton</span><span style=\"color: #657B83\">() &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    val i1 </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">Trunk</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">singleton</span><span style=\"color: #657B83\">(</span><span style=\"color: #268BD2\">TestApi</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">class</span><span style=\"color: #657B83\">);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    val i2 </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">Trunk</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">singleton</span><span style=\"color: #657B83\">(</span><span style=\"color: #268BD2\">TestApi</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">class</span><span style=\"color: #657B83\">);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #268BD2\">log</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">info</span><span style=\"color: #657B83\">(</span><span style=\"color: #2AA198\">&quot;i1: &#123;&#125;, i2: &#123;&#125;&quot;</span><span style=\"color: #657B83\">, i1, i2);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #268BD2\">Assert</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">assertEquals</span><span style=\"color: #657B83\">(i1, i2);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">&#125;</span></span></code></pre></div><p>测试结果<br><img src=\"/images/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%92%B8%E6%A1%86%E6%9E%B6/2/testret1.png\" alt=\"运行结果\"></p>\n<hr>\n<h2 id=\"类扫描加载\"><a href=\"#类扫描加载\" class=\"headerlink\" title=\"类扫描加载\"></a>类扫描加载</h2><p>Bean管理工厂有了接下来我们来实现类的扫描加载.</p>\n<h3 id=\"辅助类-1\"><a href=\"#辅助类-1\" class=\"headerlink\" title=\"辅助类\"></a>辅助类</h3><p>由于包比较多,我们可以一包一线程的方式进行扫描,加速类的扫描.<br><strong>PackageThread.java</strong></p>\n<div class=\"language-java\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">java</span><pre class=\"shiki solarized-light\" style=\"background-color: #FDF6E3\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #859900\">package</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">org.btr.ygo.core.kit</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">lombok.val</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">java.io.File</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">java.net.JarURLConnection</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">java.net.URL</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">java.net.URLDecoder</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">java.nio.charset.StandardCharsets</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">java.util.HashSet</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">java.util.LinkedHashSet</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">java.util.Objects</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">java.util.Set</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">java.util.function.Predicate</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">java.util.stream.Collectors</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\">/**</span></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\"> * 包扫描线程,一包一线程.</span></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\"> * </span><span style=\"color: #859900; font-style: italic\">@author</span><span style=\"color: #93A1A1; font-style: italic\"> &lt;a href=&quot;mailto:1159930219@qq.com&quot;&gt;BornToRain&lt;/a&gt;</span></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\"> */</span></span>\n<span class=\"line\"><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">final</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">class</span><span style=\"color: #657B83\"> </span><span style=\"color: #CB4B16\">PackageThread</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">extends</span><span style=\"color: #657B83\"> </span><span style=\"color: #6C71C4\">Thread</span><span style=\"color: #657B83\"> &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">final</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">String</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">name</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">Set</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">Class</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">?</span><span style=\"color: #657B83\">&gt;&gt; </span><span style=\"color: #268BD2\">classes</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">new</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">HashSet</span><span style=\"color: #657B83\">&lt;&gt;();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">PackageThread</span><span style=\"color: #657B83\">(</span><span style=\"color: #586E75; font-weight: bold\">String</span><span style=\"color: #657B83\"> name) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #268BD2\">setName</span><span style=\"color: #657B83\">(</span><span style=\"color: #2AA198\">&quot;ygo-package-scanner-&quot;</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">+</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">getId</span><span style=\"color: #657B83\">());</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #268BD2\">this</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">name</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> name;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  @</span><span style=\"color: #586E75; font-weight: bold\">Override</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">void</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">run</span><span style=\"color: #657B83\">() &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #268BD2\">classes</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">addAll</span><span style=\"color: #657B83\">(</span><span style=\"color: #268BD2\">getClasses</span><span style=\"color: #657B83\">(</span><span style=\"color: #B58900\">null</span><span style=\"color: #657B83\">, name));</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">Set</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">Class</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">?</span><span style=\"color: #657B83\">&gt;&gt; </span><span style=\"color: #268BD2\">getClasses</span><span style=\"color: #657B83\">(</span><span style=\"color: #586E75; font-weight: bold\">Predicate</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">Class</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">?</span><span style=\"color: #657B83\">&gt;&gt; filter, </span><span style=\"color: #586E75; font-weight: bold\">String</span><span style=\"color: #657B83\"> name) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    val classes </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">new</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">LinkedHashSet</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">Class</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">?</span><span style=\"color: #657B83\">&gt;&gt;();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #586E75; font-weight: bold\">boolean</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">recursive</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #B58900\">true</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #93A1A1; font-style: italic\">// a.b.c -&gt; a/b/c</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    val pkgDir </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">name</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">replace</span><span style=\"color: #657B83\">(</span><span style=\"color: #2AA198\">&#39;.&#39;</span><span style=\"color: #657B83\">, </span><span style=\"color: #2AA198\">&#39;/&#39;</span><span style=\"color: #657B83\">);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #268BD2\">Fn</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">ensureExec</span><span style=\"color: #657B83\">(() </span><span style=\"color: #586E75; font-weight: bold\">-&gt;</span><span style=\"color: #657B83\"> &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      val dirs </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">Thread</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">currentThread</span><span style=\"color: #657B83\">().</span><span style=\"color: #268BD2\">getContextClassLoader</span><span style=\"color: #657B83\">().</span><span style=\"color: #268BD2\">getResources</span><span style=\"color: #657B83\">(pkgDir);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #859900\">while</span><span style=\"color: #657B83\"> (</span><span style=\"color: #268BD2\">dirs</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">hasMoreElements</span><span style=\"color: #657B83\">()) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">        val url </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">dirs</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">nextElement</span><span style=\"color: #657B83\">();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">        val protocol </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">url</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">getProtocol</span><span style=\"color: #657B83\">();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">        </span><span style=\"color: #859900\">if</span><span style=\"color: #657B83\"> (</span><span style=\"color: #2AA198\">&quot;file&quot;</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">equals</span><span style=\"color: #657B83\">(protocol)) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">          val path </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">URLDecoder</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">decode</span><span style=\"color: #657B83\">(</span><span style=\"color: #268BD2\">url</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">getFile</span><span style=\"color: #657B83\">(), </span><span style=\"color: #268BD2\">StandardCharsets</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">UTF_8</span><span style=\"color: #657B83\">);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">          </span><span style=\"color: #268BD2\">findAndAdd</span><span style=\"color: #657B83\">(pkgDir, path, classes);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">        &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">        </span><span style=\"color: #859900\">else</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">if</span><span style=\"color: #657B83\"> (</span><span style=\"color: #2AA198\">&quot;jar&quot;</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">equals</span><span style=\"color: #657B83\">(protocol))</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">          </span><span style=\"color: #268BD2\">classes</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">addAll</span><span style=\"color: #657B83\">(</span><span style=\"color: #268BD2\">getJarClasses</span><span style=\"color: #657B83\">(pkgDir, name, url, recursive));</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    &#125;);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #859900\">return</span><span style=\"color: #657B83\"> </span><span style=\"color: #B58900\">null</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">==</span><span style=\"color: #657B83\"> filter </span><span style=\"color: #859900\">?</span><span style=\"color: #657B83\"> classes </span><span style=\"color: #859900\">:</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">classes</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">stream</span><span style=\"color: #657B83\">().</span><span style=\"color: #268BD2\">filter</span><span style=\"color: #657B83\">(filter).</span><span style=\"color: #268BD2\">collect</span><span style=\"color: #657B83\">(</span><span style=\"color: #268BD2\">Collectors</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">toSet</span><span style=\"color: #657B83\">());</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">private</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">Set</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">Class</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">?</span><span style=\"color: #657B83\">&gt;&gt; </span><span style=\"color: #268BD2\">getJarClasses</span><span style=\"color: #657B83\">(</span><span style=\"color: #586E75; font-weight: bold\">String</span><span style=\"color: #657B83\"> pkgDir, </span><span style=\"color: #586E75; font-weight: bold\">String</span><span style=\"color: #657B83\"> name, </span><span style=\"color: #586E75; font-weight: bold\">URL</span><span style=\"color: #657B83\"> url,</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #586E75; font-weight: bold\">boolean</span><span style=\"color: #657B83\"> recursive) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    val classes </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">new</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">LinkedHashSet</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">Class</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">?</span><span style=\"color: #657B83\">&gt;&gt;();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #268BD2\">Fn</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">ensureRun</span><span style=\"color: #657B83\">(() </span><span style=\"color: #586E75; font-weight: bold\">-&gt;</span><span style=\"color: #657B83\"> &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #93A1A1; font-style: italic\">// 去掉第一个.</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #586E75; font-weight: bold\">var</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">pkgPath</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> (</span><span style=\"color: #268BD2\">name</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">startsWith</span><span style=\"color: #657B83\">(</span><span style=\"color: #2AA198\">&quot;.&quot;</span><span style=\"color: #657B83\">)) </span><span style=\"color: #859900\">?</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">name</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">substring</span><span style=\"color: #657B83\">(</span><span style=\"color: #D33682\">1</span><span style=\"color: #657B83\">) </span><span style=\"color: #859900\">:</span><span style=\"color: #657B83\"> name;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      val jar </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> ((JarURLConnection) </span><span style=\"color: #268BD2\">url</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">openConnection</span><span style=\"color: #657B83\">()).</span><span style=\"color: #268BD2\">getJarFile</span><span style=\"color: #657B83\">();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      val entries </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">jar</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">entries</span><span style=\"color: #657B83\">();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #859900\">while</span><span style=\"color: #657B83\"> (</span><span style=\"color: #268BD2\">entries</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">hasMoreElements</span><span style=\"color: #657B83\">()) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">        val entry </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">entries</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">nextElement</span><span style=\"color: #657B83\">();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">        </span><span style=\"color: #586E75; font-weight: bold\">var</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">entryName</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">entry</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">getName</span><span style=\"color: #657B83\">();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">        </span><span style=\"color: #93A1A1; font-style: italic\">// 去掉第一个/</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">        </span><span style=\"color: #859900\">if</span><span style=\"color: #657B83\"> (</span><span style=\"color: #268BD2\">entryName</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">charAt</span><span style=\"color: #657B83\">(</span><span style=\"color: #D33682\">0</span><span style=\"color: #657B83\">) </span><span style=\"color: #859900\">==</span><span style=\"color: #657B83\"> </span><span style=\"color: #2AA198\">&#39;/&#39;</span><span style=\"color: #657B83\">) entryName </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">entryName</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">substring</span><span style=\"color: #657B83\">(</span><span style=\"color: #D33682\">1</span><span style=\"color: #657B83\">);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">        </span><span style=\"color: #859900\">if</span><span style=\"color: #657B83\"> (</span><span style=\"color: #268BD2\">entryName</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">startsWith</span><span style=\"color: #657B83\">(pkgDir)) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">          val idx </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">entryName</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">lastIndexOf</span><span style=\"color: #657B83\">(</span><span style=\"color: #2AA198\">&#39;/&#39;</span><span style=\"color: #657B83\">);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">          </span><span style=\"color: #93A1A1; font-style: italic\">// entryName存在/说明是package</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">          </span><span style=\"color: #93A1A1; font-style: italic\">// java/lang -&gt; java.lang</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">          </span><span style=\"color: #859900\">if</span><span style=\"color: #657B83\"> (idx </span><span style=\"color: #859900\">!=</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">-</span><span style=\"color: #D33682\">1</span><span style=\"color: #657B83\">) pkgPath </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">entryName</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">substring</span><span style=\"color: #657B83\">(</span><span style=\"color: #D33682\">0</span><span style=\"color: #657B83\">, idx).</span><span style=\"color: #268BD2\">replace</span><span style=\"color: #657B83\">(</span><span style=\"color: #2AA198\">&#39;/&#39;</span><span style=\"color: #657B83\">, </span><span style=\"color: #2AA198\">&#39;.&#39;</span><span style=\"color: #657B83\">);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">          </span><span style=\"color: #859900\">if</span><span style=\"color: #657B83\"> ((idx </span><span style=\"color: #859900\">!=</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">-</span><span style=\"color: #D33682\">1</span><span style=\"color: #657B83\">) </span><span style=\"color: #859900\">||</span><span style=\"color: #657B83\"> recursive) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">            </span><span style=\"color: #93A1A1; font-style: italic\">// class文件</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">            </span><span style=\"color: #859900\">if</span><span style=\"color: #657B83\"> (</span><span style=\"color: #268BD2\">entryName</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">endsWith</span><span style=\"color: #657B83\">(</span><span style=\"color: #2AA198\">&quot;.class&quot;</span><span style=\"color: #657B83\">) </span><span style=\"color: #859900\">&amp;&amp;</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">!</span><span style=\"color: #268BD2\">entry</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">isDirectory</span><span style=\"color: #657B83\">()) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">              </span><span style=\"color: #93A1A1; font-style: italic\">// 提取class文件名</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">              val clsName </span><span style=\"color: #859900\">=</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">                entryName</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">                  .</span><span style=\"color: #268BD2\">substring</span><span style=\"color: #657B83\">(</span><span style=\"color: #268BD2\">pkgPath</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">length</span><span style=\"color: #657B83\">() </span><span style=\"color: #859900\">+</span><span style=\"color: #657B83\"> </span><span style=\"color: #D33682\">1</span><span style=\"color: #657B83\">, </span><span style=\"color: #268BD2\">entryName</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">lastIndexOf</span><span style=\"color: #657B83\">(</span><span style=\"color: #2AA198\">&quot;.class&quot;</span><span style=\"color: #657B83\">));</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">              </span><span style=\"color: #268BD2\">classes</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">add</span><span style=\"color: #657B83\">(</span><span style=\"color: #268BD2\">Thread</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">currentThread</span><span style=\"color: #657B83\">().</span><span style=\"color: #268BD2\">getContextClassLoader</span><span style=\"color: #657B83\">()</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">                .</span><span style=\"color: #268BD2\">loadClass</span><span style=\"color: #657B83\">(pkgPath </span><span style=\"color: #859900\">+</span><span style=\"color: #657B83\"> </span><span style=\"color: #2AA198\">&#39;.&#39;</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">+</span><span style=\"color: #657B83\"> clsName));</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">            &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">          &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">        &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #859900\">return</span><span style=\"color: #657B83\"> </span><span style=\"color: #B58900\">null</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    &#125;, pkgDir, name, url);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #859900\">return</span><span style=\"color: #657B83\"> classes;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">private</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">void</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">findAndAdd</span><span style=\"color: #657B83\">(</span><span style=\"color: #586E75; font-weight: bold\">String</span><span style=\"color: #657B83\"> pkgDir, </span><span style=\"color: #586E75; font-weight: bold\">String</span><span style=\"color: #657B83\"> path, </span><span style=\"color: #586E75; font-weight: bold\">Set</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">Class</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">?</span><span style=\"color: #657B83\">&gt;&gt; classes) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #268BD2\">Fn</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">ensureExec</span><span style=\"color: #657B83\">(() </span><span style=\"color: #586E75; font-weight: bold\">-&gt;</span><span style=\"color: #657B83\"> &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      val file </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">new</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">File</span><span style=\"color: #657B83\">(path);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #859900\">if</span><span style=\"color: #657B83\"> (</span><span style=\"color: #859900\">!</span><span style=\"color: #268BD2\">file</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">exists</span><span style=\"color: #657B83\">() </span><span style=\"color: #859900\">||</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">!</span><span style=\"color: #268BD2\">file</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">isDirectory</span><span style=\"color: #657B83\">()) </span><span style=\"color: #859900\">return</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      val classFiles </span><span style=\"color: #859900\">=</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">        </span><span style=\"color: #268BD2\">file</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">listFiles</span><span style=\"color: #657B83\">(pathname </span><span style=\"color: #586E75; font-weight: bold\">-&gt;</span><span style=\"color: #657B83\"> (</span><span style=\"color: #268BD2\">file</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">isDirectory</span><span style=\"color: #657B83\">()) </span><span style=\"color: #859900\">||</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">file</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">getName</span><span style=\"color: #657B83\">().</span><span style=\"color: #268BD2\">endsWith</span><span style=\"color: #657B83\">(</span><span style=\"color: #2AA198\">&quot;.class&quot;</span><span style=\"color: #657B83\">));</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #859900\">if</span><span style=\"color: #657B83\"> (</span><span style=\"color: #268BD2\">Objects</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">isNull</span><span style=\"color: #657B83\">(classFiles)) </span><span style=\"color: #859900\">return</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #93A1A1; font-style: italic\">// 去掉第一个.</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      val pkgPath </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> (</span><span style=\"color: #268BD2\">pkgDir</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">startsWith</span><span style=\"color: #657B83\">(</span><span style=\"color: #2AA198\">&quot;.&quot;</span><span style=\"color: #657B83\">)) </span><span style=\"color: #859900\">?</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">pkgDir</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">substring</span><span style=\"color: #657B83\">(</span><span style=\"color: #D33682\">1</span><span style=\"color: #657B83\">) </span><span style=\"color: #859900\">:</span><span style=\"color: #657B83\"> pkgDir;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #93A1A1; font-style: italic\">// 是否存在另一个文件夹</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      val processedName </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">pkgPath</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">replace</span><span style=\"color: #657B83\">(</span><span style=\"color: #2AA198\">&#39;/&#39;</span><span style=\"color: #657B83\">, </span><span style=\"color: #2AA198\">&#39;.&#39;</span><span style=\"color: #657B83\">);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #859900\">for</span><span style=\"color: #657B83\"> (</span><span style=\"color: #586E75; font-weight: bold\">File</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">cls</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">:</span><span style=\"color: #657B83\"> classFiles) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">        </span><span style=\"color: #93A1A1; font-style: italic\">// 目录直接跳过</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">        </span><span style=\"color: #859900\">if</span><span style=\"color: #657B83\"> (</span><span style=\"color: #268BD2\">cls</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">isDirectory</span><span style=\"color: #657B83\">())</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">          </span><span style=\"color: #268BD2\">findAndAdd</span><span style=\"color: #657B83\">(processedName </span><span style=\"color: #859900\">+</span><span style=\"color: #657B83\"> </span><span style=\"color: #2AA198\">&#39;.&#39;</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">+</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">cls</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">getName</span><span style=\"color: #657B83\">(), </span><span style=\"color: #268BD2\">cls</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">getAbsolutePath</span><span style=\"color: #657B83\">(),</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">            classes);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">        </span><span style=\"color: #859900\">else</span><span style=\"color: #657B83\"> &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">          val clsName </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">cls</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">getName</span><span style=\"color: #657B83\">();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">          val name </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">clsName</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">substring</span><span style=\"color: #657B83\">(</span><span style=\"color: #D33682\">0</span><span style=\"color: #657B83\">, </span><span style=\"color: #268BD2\">clsName</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">lastIndexOf</span><span style=\"color: #657B83\">(</span><span style=\"color: #2AA198\">&quot;.class&quot;</span><span style=\"color: #657B83\">));</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">          </span><span style=\"color: #268BD2\">classes</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">add</span><span style=\"color: #657B83\">(</span><span style=\"color: #268BD2\">Thread</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">currentThread</span><span style=\"color: #657B83\">().</span><span style=\"color: #268BD2\">getContextClassLoader</span><span style=\"color: #657B83\">()</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">            .</span><span style=\"color: #268BD2\">loadClass</span><span style=\"color: #657B83\">(processedName </span><span style=\"color: #859900\">+</span><span style=\"color: #657B83\"> </span><span style=\"color: #2AA198\">&#39;.&#39;</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">+</span><span style=\"color: #657B83\"> name));</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">        &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    &#125;, pkgDir, path);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">&#125;</span></span></code></pre></div><h3 id=\"本体-1\"><a href=\"#本体-1\" class=\"headerlink\" title=\"本体\"></a>本体</h3><p><strong>Packages.java</strong></p>\n<div class=\"language-java\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">java</span><pre class=\"shiki solarized-light\" style=\"background-color: #FDF6E3\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #859900\">package</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">org.btr.ygo.core.kit</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">lombok.extern.log4j.Log4j2</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">lombok.val</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">org.btr.ygo.core.constant.Console</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">java.util.Arrays</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">java.util.HashSet</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">java.util.Set</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">java.util.stream.Collectors</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\">/**</span></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\"> * </span><span style=\"color: #859900; font-style: italic\">@author</span><span style=\"color: #93A1A1; font-style: italic\"> &lt;a href=&quot;mailto:1159930219@qq.com&quot;&gt;BornToRain&lt;/a&gt;</span></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\"> */</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">@</span><span style=\"color: #586E75; font-weight: bold\">Log4j2</span></span>\n<span class=\"line\"><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">final</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">class</span><span style=\"color: #657B83\"> </span><span style=\"color: #CB4B16\">Packages</span><span style=\"color: #657B83\"> &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #93A1A1; font-style: italic\">// 忽略不扫描的包</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">private</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">static</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">final</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">Set</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">String</span><span style=\"color: #657B83\">&gt; </span><span style=\"color: #268BD2\">IGNORE_PACKAGES</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">Set</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">of</span><span style=\"color: #657B83\">(</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #2AA198\">&quot;ch.qos.logback&quot;</span><span style=\"color: #657B83\">,</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #2AA198\">&quot;io.vertx.core&quot;</span><span style=\"color: #657B83\">,</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #2AA198\">&quot;io.netty&quot;</span><span style=\"color: #657B83\">,</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #2AA198\">&quot;com.fasterxml.jackson&quot;</span><span style=\"color: #657B83\">,</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #2AA198\">&quot;com.esotericsoftware&quot;</span><span style=\"color: #657B83\">,</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #2AA198\">&quot;java&quot;</span><span style=\"color: #657B83\">,</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #2AA198\">&quot;javax&quot;</span><span style=\"color: #657B83\">,</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #2AA198\">&quot;jdk&quot;</span><span style=\"color: #657B83\">,</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #2AA198\">&quot;sun&quot;</span><span style=\"color: #657B83\">,</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #2AA198\">&quot;groovy&quot;</span><span style=\"color: #657B83\">,</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #2AA198\">&quot;org.graalvm&quot;</span><span style=\"color: #657B83\">,</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #2AA198\">&quot;org.apache&quot;</span><span style=\"color: #657B83\">,</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #2AA198\">&quot;org.jboss&quot;</span><span style=\"color: #657B83\">,</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #2AA198\">&quot;com.sun&quot;</span><span style=\"color: #657B83\">,</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #2AA198\">&quot;org.slf4j&quot;</span><span style=\"color: #657B83\">,</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #2AA198\">&quot;org.yaml&quot;</span><span style=\"color: #657B83\">,</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #2AA198\">&quot;org.junit&quot;</span><span style=\"color: #657B83\">,</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #2AA198\">&quot;org.apache.logging.log4j&quot;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  );</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">static</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">Set</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">Class</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">?</span><span style=\"color: #657B83\">&gt;&gt; </span><span style=\"color: #268BD2\">scan</span><span style=\"color: #657B83\">() &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #859900\">if</span><span style=\"color: #657B83\"> (</span><span style=\"color: #268BD2\">Trunk</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">CLASSES</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">isEmpty</span><span style=\"color: #657B83\">()) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      val classes </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">scan</span><span style=\"color: #657B83\">(</span><span style=\"color: #268BD2\">getPackages</span><span style=\"color: #657B83\">().</span><span style=\"color: #268BD2\">toArray</span><span style=\"color: #657B83\">(</span><span style=\"color: #859900\">new</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">String</span><span style=\"color: #657B83\">[]&#123;&#125;));</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #268BD2\">Trunk</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">CLASSES</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">addAll</span><span style=\"color: #657B83\">(classes);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #268BD2\">log</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">info</span><span style=\"color: #657B83\">(</span><span style=\"color: #268BD2\">Console</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">SCANNED</span><span style=\"color: #657B83\">, </span><span style=\"color: #2AA198\">&quot;Class&quot;</span><span style=\"color: #657B83\">, </span><span style=\"color: #268BD2\">classes</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">size</span><span style=\"color: #657B83\">());</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #859900\">return</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">Trunk</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">CLASSES</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">private</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">static</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">Set</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">String</span><span style=\"color: #657B83\">&gt; </span><span style=\"color: #268BD2\">getPackages</span><span style=\"color: #657B83\">() &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    val pkgs </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">Arrays</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">stream</span><span style=\"color: #657B83\">(</span><span style=\"color: #268BD2\">Package</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">getPackages</span><span style=\"color: #657B83\">())</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      .</span><span style=\"color: #268BD2\">map</span><span style=\"color: #657B83\">(Package</span><span style=\"color: #859900\">::</span><span style=\"color: #657B83\">getName)</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      .</span><span style=\"color: #268BD2\">filter</span><span style=\"color: #657B83\">(name </span><span style=\"color: #586E75; font-weight: bold\">-&gt;</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">IGNORE_PACKAGES</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">stream</span><span style=\"color: #657B83\">().</span><span style=\"color: #268BD2\">noneMatch</span><span style=\"color: #657B83\">(name</span><span style=\"color: #859900\">::</span><span style=\"color: #657B83\">startsWith))</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      .</span><span style=\"color: #268BD2\">collect</span><span style=\"color: #657B83\">(</span><span style=\"color: #268BD2\">Collectors</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">toSet</span><span style=\"color: #657B83\">());</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #268BD2\">log</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">info</span><span style=\"color: #657B83\">(</span><span style=\"color: #268BD2\">Console</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">SCANNED</span><span style=\"color: #657B83\">, </span><span style=\"color: #2AA198\">&quot;Package&quot;</span><span style=\"color: #657B83\">, </span><span style=\"color: #268BD2\">pkgs</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">size</span><span style=\"color: #657B83\">());</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #859900\">return</span><span style=\"color: #657B83\"> pkgs;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #93A1A1; font-style: italic\">// 多线程扫描</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">private</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">static</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">HashSet</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">Class</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">?</span><span style=\"color: #657B83\">&gt;&gt; </span><span style=\"color: #268BD2\">scan</span><span style=\"color: #657B83\">(</span><span style=\"color: #586E75; font-weight: bold\">String</span><span style=\"color: #657B83\">[] dirs) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    val threads </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">Arrays</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">stream</span><span style=\"color: #657B83\">(dirs).</span><span style=\"color: #268BD2\">map</span><span style=\"color: #657B83\">(PackageThread</span><span style=\"color: #859900\">::new</span><span style=\"color: #657B83\">).</span><span style=\"color: #268BD2\">collect</span><span style=\"color: #657B83\">(</span><span style=\"color: #268BD2\">Collectors</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">toSet</span><span style=\"color: #657B83\">());</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #268BD2\">threads</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">forEach</span><span style=\"color: #657B83\">(Thread</span><span style=\"color: #859900\">::</span><span style=\"color: #657B83\">start);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    val ret </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">new</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">HashSet</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">Class</span><span style=\"color: #657B83\">&lt;</span><span style=\"color: #586E75; font-weight: bold\">?</span><span style=\"color: #657B83\">&gt;&gt;();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #859900\">try</span><span style=\"color: #657B83\"> &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #93A1A1; font-style: italic\">// 主线程等待子线程全部扫描完毕</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #859900\">for</span><span style=\"color: #657B83\"> (</span><span style=\"color: #586E75; font-weight: bold\">PackageThread</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">thread</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">:</span><span style=\"color: #657B83\"> threads) </span><span style=\"color: #268BD2\">thread</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">join</span><span style=\"color: #657B83\">();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #93A1A1; font-style: italic\">// 将所有线程值合并</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #859900\">for</span><span style=\"color: #657B83\"> (</span><span style=\"color: #586E75; font-weight: bold\">PackageThread</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">thread</span><span style=\"color: #657B83\"> </span><span style=\"color: #859900\">:</span><span style=\"color: #657B83\"> threads) </span><span style=\"color: #268BD2\">ret</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">addAll</span><span style=\"color: #657B83\">(</span><span style=\"color: #268BD2\">thread</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">classes</span><span style=\"color: #657B83\">);</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    &#125; </span><span style=\"color: #859900\">catch</span><span style=\"color: #657B83\"> (</span><span style=\"color: #586E75; font-weight: bold\">Exception</span><span style=\"color: #657B83\"> ex) &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">      </span><span style=\"color: #268BD2\">ex</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">printStackTrace</span><span style=\"color: #657B83\">();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #859900\">return</span><span style=\"color: #657B83\"> ret;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">&#125;</span></span></code></pre></div><h3 id=\"测试-1\"><a href=\"#测试-1\" class=\"headerlink\" title=\"测试\"></a>测试</h3><p><strong>PackageTest.java</strong></p>\n<div class=\"language-java\"><button title=\"Copy code\" class=\"copy\"></button><span class=\"lang\">java</span><pre class=\"shiki solarized-light\" style=\"background-color: #FDF6E3\" tabindex=\"0\"><code><span class=\"line\"><span style=\"color: #859900\">package</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">org.btr.ygo.core.kit</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">lombok.val</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">org.hamcrest.CoreMatchers</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">org.junit.Assert</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"><span style=\"color: #859900\">import</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">org.junit.Test</span><span style=\"color: #657B83\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\">/**</span></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\"> * </span><span style=\"color: #859900; font-style: italic\">@author</span><span style=\"color: #93A1A1; font-style: italic\"> &lt;a href=&quot;mailto:1159930219@qq.com&quot;&gt;BornToRain&lt;/a&gt;</span></span>\n<span class=\"line\"><span style=\"color: #93A1A1; font-style: italic\"> */</span></span>\n<span class=\"line\"><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">class</span><span style=\"color: #657B83\"> </span><span style=\"color: #CB4B16\">PackagesTest</span><span style=\"color: #657B83\"> &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  @</span><span style=\"color: #586E75; font-weight: bold\">Test</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  </span><span style=\"color: #586E75; font-weight: bold\">public</span><span style=\"color: #657B83\"> </span><span style=\"color: #586E75; font-weight: bold\">void</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">test</span><span style=\"color: #657B83\">() &#123;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    val classes </span><span style=\"color: #859900\">=</span><span style=\"color: #657B83\"> </span><span style=\"color: #268BD2\">Packages</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">scan</span><span style=\"color: #657B83\">();</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">    </span><span style=\"color: #268BD2\">Assert</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">assertThat</span><span style=\"color: #657B83\">(classes, </span><span style=\"color: #268BD2\">CoreMatchers</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">hasItem</span><span style=\"color: #657B83\">(</span><span style=\"color: #268BD2\">Packages</span><span style=\"color: #657B83\">.</span><span style=\"color: #268BD2\">class</span><span style=\"color: #657B83\">));</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">  &#125;</span></span>\n<span class=\"line\"><span style=\"color: #657B83\">&#125;</span></span></code></pre></div><p>测试结果<br><img src=\"/images/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%92%B8%E6%A1%86%E6%9E%B6/2/testret2.png\" alt=\"运行结果\"></p>\n<hr>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>这一章我们完成了核心模块的龙骨搭建,让它拥有了两个最原始的功能,即工厂和类集合,有了这俩我们才能开发其他的组件.</p>\n","text":"项目结构上文说到框架包含Ioc、Di、Orm、Cache等功能,其中只有前两者为核心功能.那么结构上可以采用分包结构开发,即分为核心、组件等功能包,如下. or...","permalink":"/post/从零开始撸框架(2)-项目龙骨","photos":[],"count_time":{"symbolsCount":"14k","symbolsTime":"13 mins."},"categories":[{"name":"从零开始","slug":"从零开始","count":8,"path":"api/categories/从零开始.json"}],"tags":[{"name":"Vert.x","slug":"Vert-x","count":8,"path":"api/tags/Vert-x.json"},{"name":"Actor","slug":"Actor","count":8,"path":"api/tags/Actor.json"},{"name":"设计模式","slug":"设计模式","count":8,"path":"api/tags/设计模式.json"},{"name":"Java","slug":"Java","count":9,"path":"api/tags/Java.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84\"><span class=\"toc-text\">项目结构</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%B7%A5%E5%8E%82\"><span class=\"toc-text\">工厂</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E8%BE%85%E5%8A%A9%E7%B1%BB\"><span class=\"toc-text\">辅助类</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%9C%AC%E4%BD%93\"><span class=\"toc-text\">本体</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%B5%8B%E8%AF%95\"><span class=\"toc-text\">测试</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E7%B1%BB%E6%89%AB%E6%8F%8F%E5%8A%A0%E8%BD%BD\"><span class=\"toc-text\">类扫描加载</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E8%BE%85%E5%8A%A9%E7%B1%BB-1\"><span class=\"toc-text\">辅助类</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%9C%AC%E4%BD%93-1\"><span class=\"toc-text\">本体</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%B5%8B%E8%AF%95-1\"><span class=\"toc-text\">测试</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%80%BB%E7%BB%93\"><span class=\"toc-text\">总结</span></a></li></ol>","author":{"name":"因雨而生","slug":"blog-author","avatar":"/images/avatar.jpg","link":"/","description":"一直没脱离低级趣味的Coder","socials":{"github":"https://github.com/BornToRain","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{"title":"从零开始撸框架(3)-类扫描器","uid":"bf9123d57d7a0fda9f11ed154298fba1","slug":"从零开始撸框架(3)-类扫描器","date":"2021-05-01T16:01:49.000Z","updated":"2021-05-02T00:03:01.318Z","comments":true,"path":"api/articles/从零开始撸框架(3)-类扫描器.json","keywords":["Coder","Scalaer","Javaer"],"cover":"/images/vertxlogo.png","text":"上一章我们已经把每个包中的类都统一加载到一个Set中了,以后凡是需要用到类的场景我们都可以从Set集合中取出,但是光这样还不够好.往后所有操作都依赖于这一个集合...","permalink":"/post/从零开始撸框架(3)-类扫描器","photos":[],"count_time":{"symbolsCount":"17k","symbolsTime":"15 mins."},"categories":[{"name":"从零开始","slug":"从零开始","count":8,"path":"api/categories/从零开始.json"}],"tags":[{"name":"Vert.x","slug":"Vert-x","count":8,"path":"api/tags/Vert-x.json"},{"name":"Actor","slug":"Actor","count":8,"path":"api/tags/Actor.json"},{"name":"设计模式","slug":"设计模式","count":8,"path":"api/tags/设计模式.json"},{"name":"Java","slug":"Java","count":9,"path":"api/tags/Java.json"}],"author":{"name":"因雨而生","slug":"blog-author","avatar":"/images/avatar.jpg","link":"/","description":"一直没脱离低级趣味的Coder","socials":{"github":"https://github.com/BornToRain","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"奇淫巧技(2)-Jvm篇","uid":"1da24bfae57d43586cc931d1d18b42d9","slug":"奇淫巧技(2)-Jvm篇","date":"2021-04-28T00:04:30.000Z","updated":"2021-04-29T02:04:35.988Z","comments":true,"path":"api/articles/奇淫巧技(2)-Jvm篇.json","keywords":["Coder","Scalaer","Javaer"],"cover":"/images/javalogo.png","text":"函数内联在讲函数内联之前还得讲一个Jvm经常遇到的异常StackOverFlowException,该异常一般翻译成堆栈溢出异常,其实正确或者说更严谨的翻译应该...","permalink":"/post/奇淫巧技(2)-Jvm篇","photos":[],"count_time":{"symbolsCount":"1k","symbolsTime":"1 mins."},"categories":[{"name":"奇淫巧技","slug":"奇淫巧技","count":2,"path":"api/categories/奇淫巧技.json"}],"tags":[{"name":"Jvm","slug":"Jvm","count":1,"path":"api/tags/Jvm.json"}],"author":{"name":"因雨而生","slug":"blog-author","avatar":"/images/avatar.jpg","link":"/","description":"一直没脱离低级趣味的Coder","socials":{"github":"https://github.com/BornToRain","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}