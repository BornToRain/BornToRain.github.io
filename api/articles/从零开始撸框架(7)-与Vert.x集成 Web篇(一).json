{"title":"从零开始撸框架(7)-与Vert.x集成 Web篇(一)","uid":"c38b17588d251cd9846139dacf4f50ed","slug":"从零开始撸框架(7)-与Vert.x集成 Web篇(一)","date":"2021-05-10T06:50:32.000Z","updated":"2021-06-09T08:46:02.182Z","comments":true,"path":"api/articles/从零开始撸框架(7)-与Vert.x集成 Web篇(一).json","keywords":["Coder","Scalaer","Javaer"],"cover":"/images/vertxlogo.png","content":"<p>上一篇讲完了与Vert.x集成的整体情况,这一篇开始与<em>vertx-web</em>集成.</p>\n<p>这些内容我们主要在<em>web</em>模块中进行开发.</p>\n<h2 id=\"Web全局集成\"><a href=\"#Web全局集成\" class=\"headerlink\" title=\"Web全局集成\"></a>Web全局集成</h2><p>web组件下的<em>build.gradle</em><br><strong>build.gradle</strong></p>\n<figure class=\"highlight gradle\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">dependencies</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 核心组件</span></span><br><span class=\"line\">  <span class=\"keyword\">compile</span> <span class=\"keyword\">project</span>(<span class=\"string\">&quot;:core&quot;</span>)</span><br><span class=\"line\">  <span class=\"keyword\">compile</span> <span class=\"string\">&quot;io.vertx:vertx-web:$vertxVersion&quot;</span></span><br><span class=\"line\">    <span class=\"comment\">// jsr311</span></span><br><span class=\"line\">    <span class=\"string\">&quot;javax.ws.rs:javax.ws.rs-api:2.1.1&quot;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"注解\"><a href=\"#注解\" class=\"headerlink\" title=\"注解\"></a>注解</h3><p>核心组件注解我们是基于jsr330,web组件这我们基于jsr311+自定义注解.</p>\n<h4 id=\"字段级\"><a href=\"#字段级\" class=\"headerlink\" title=\"字段级\"></a>字段级</h4><ul>\n<li>@PathParam 原生注解,获取地址栏参数.</li>\n<li>@QueryParam 原生注解,获取QuerySring.</li>\n<li>@CookieParam 原生注解,获取Cookie.</li>\n<li>@HeaderParam 原生注解,获取Header.</li>\n<li>@BodyParam 自定义注解,获取请求体,与<em>Spring</em>中的 <em>@RequestBody</em> 同含义.</li>\n<li>@SessionParam 自定义注解,获取Session.</li>\n<li>@ResponseStatus 自定义注解,设置默认响应http状态码.</li>\n</ul>\n<p>这里只放出自定义注解代码.<br><strong>BodyParam.java</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> org.btr.ygo.web.annotations;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.Documented;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.ElementType;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.Inherited;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.Retention;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.Target;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> &lt;a href=&quot;mailto:1159930219@qq.com&quot;&gt;BornToRain&lt;/a&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Inherited</span></span><br><span class=\"line\"><span class=\"meta\">@Documented</span></span><br><span class=\"line\"><span class=\"meta\">@Target(&#123;ElementType.PARAMETER, ElementType.ANNOTATION_TYPE&#125;)</span></span><br><span class=\"line\"><span class=\"meta\">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"meta\">@interface</span> BodyParam &#123;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>SessionParam.java</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> org.btr.ygo.web.annotations;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.Documented;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.ElementType;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.Inherited;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.Retention;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.Target;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> &lt;a href=&quot;mailto:1159930219@qq.com&quot;&gt;BornToRain&lt;/a&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Inherited</span></span><br><span class=\"line\"><span class=\"meta\">@Documented</span></span><br><span class=\"line\"><span class=\"meta\">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class=\"line\"><span class=\"meta\">@Target(&#123;ElementType.PARAMETER, ElementType.ANNOTATION_TYPE&#125;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"meta\">@interface</span> SessionParam &#123;</span><br><span class=\"line\">  String <span class=\"title function_\">value</span><span class=\"params\">()</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>ResponseStatus.java</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> org.btr.ygo.web.annotations;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> org.btr.ygo.web.constant.HttpStatus;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.Documented;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.ElementType;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.Inherited;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.Retention;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.Target;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> &lt;a href=&quot;mailto:1159930219@qq.com&quot;&gt;BornToRain&lt;/a&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Inherited</span></span><br><span class=\"line\"><span class=\"meta\">@Documented</span></span><br><span class=\"line\"><span class=\"meta\">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class=\"line\"><span class=\"meta\">@Target(&#123;ElementType.METHOD,ElementType.TYPE, ElementType.ANNOTATION_TYPE&#125;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"meta\">@interface</span> ResponseStatus &#123;</span><br><span class=\"line\">  HttpStatus <span class=\"title function_\">value</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> HttpStatus.INTERNAL_SERVER_ERROR;</span><br><span class=\"line\">  HttpStatus <span class=\"title function_\">code</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> HttpStatus.INTERNAL_SERVER_ERROR;</span><br><span class=\"line\">  String <span class=\"title function_\">msg</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"类级\"><a href=\"#类级\" class=\"headerlink\" title=\"类级\"></a>类级</h4><ul>\n<li>@Api 自定义注解,标识当前类是一个Api,与<em>Spring</em>中的 <em>@Controller</em> 同含义.</li>\n</ul>\n<p><strong>Api.java</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> org.btr.ygo.annotations;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.Documented;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.ElementType;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.Inherited;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.Retention;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.RetentionPolicy;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.annotation.Target;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> &lt;a href=&quot;mailto:1159930219@qq.com&quot;&gt;BornToRain&lt;/a&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Inherited</span></span><br><span class=\"line\"><span class=\"meta\">@Documented</span></span><br><span class=\"line\"><span class=\"meta\">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class=\"line\"><span class=\"meta\">@Target(&#123;ElementType.TYPE,ElementType.ANNOTATION_TYPE&#125;)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"meta\">@interface</span> Api &#123;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h3><p>web服务配置多种多样,我们也需要定义对应的实体类.</p>\n<h4 id=\"cors\"><a href=\"#cors\" class=\"headerlink\" title=\"cors\"></a>cors</h4><h5 id=\"配置对象\"><a href=\"#配置对象\" class=\"headerlink\" title=\"配置对象\"></a>配置对象</h5><p><strong>Cors.java</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">package</span> org.btr.ygo.web.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> io.vertx.core.http.HttpMethod;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.AccessLevel;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.Data;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.experimental.Accessors;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.experimental.FieldDefaults;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Set;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> &lt;a href=&quot;mailto:1159930219@qq.com&quot;&gt;BornToRain&lt;/a&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Data</span></span><br><span class=\"line\"><span class=\"meta\">@Accessors(chain = true)</span></span><br><span class=\"line\"><span class=\"meta\">@FieldDefaults(level = AccessLevel.PRIVATE)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Cors</span> &#123;</span><br><span class=\"line\">  String origin;</span><br><span class=\"line\">  Boolean allowCredentials;</span><br><span class=\"line\">  Set&lt;HttpMethod&gt; allowedMethods;</span><br><span class=\"line\">  Set&lt;String&gt; allowedHeaders;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"配置读取\"><a href=\"#配置读取\" class=\"headerlink\" title=\"配置读取\"></a>配置读取</h5><p><strong>CorsConfig.java</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> org.btr.ygo.web.config;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> io.vertx.core.http.HttpMethod;</span><br><span class=\"line\"><span class=\"keyword\">import</span> io.vertx.core.json.JsonArray;</span><br><span class=\"line\"><span class=\"keyword\">import</span> io.vertx.core.json.JsonObject;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.extern.log4j.Log4j2;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.val;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.btr.ygo.core.config.IConfig;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.btr.ygo.core.config.YgoConfig;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.btr.ygo.core.constant.Const;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.btr.ygo.core.kit.Trunk;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Set;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.function.Function;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.stream.Collectors;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> &lt;a href=&quot;mailto:1159930219@qq.com&quot;&gt;BornToRain&lt;/a&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Log4j2</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">class</span> <span class=\"title class_\">CorsConfig</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">IConfig</span>&lt;Cors&gt; &#123;</span><br><span class=\"line\">  <span class=\"meta\">@Override</span></span><br><span class=\"line\">  <span class=\"keyword\">public</span> Cors <span class=\"title function_\">read</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    <span class=\"type\">val</span> <span class=\"variable\">config</span> <span class=\"operator\">=</span> Trunk.&lt;YgoConfig&gt;singleton(YgoConfig.class).read();</span><br><span class=\"line\">    <span class=\"keyword\">return</span> read(config.getJsonObject(Const.VERTX).getJsonObject(<span class=\"string\">&quot;cors&quot;</span>));</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">public</span> Cors <span class=\"title function_\">read</span><span class=\"params\">(JsonObject json)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Cors</span>().setOrigin(json.getString(<span class=\"string\">&quot;origin&quot;</span>))</span><br><span class=\"line\">      .setAllowCredentials(json.getBoolean(<span class=\"string\">&quot;allow-credentials&quot;</span>))</span><br><span class=\"line\">      .setAllowedHeaders(toSet(json.getJsonArray(<span class=\"string\">&quot;allowed-headers&quot;</span>), Object::toString))</span><br><span class=\"line\">      .setAllowedMethods(toSet(json.getJsonArray(<span class=\"string\">&quot;allowed-methods&quot;</span>),</span><br><span class=\"line\">          d -&gt; <span class=\"keyword\">new</span> <span class=\"title class_\">HttpMethod</span>(d.toString().toUpperCase())));</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">private</span> &lt;T&gt; Set&lt;T&gt; <span class=\"title function_\">toSet</span><span class=\"params\">(JsonArray xs, Function&lt;Object, T&gt; fn)</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> xs.stream().map(fn).collect(Collectors.toSet());</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"配置示例\"><a href=\"#配置示例\" class=\"headerlink\" title=\"配置示例\"></a>配置示例</h5><p><strong>application.yaml</strong></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">ygo:</span></span><br><span class=\"line\">  <span class=\"attr\">profile:</span> <span class=\"string\">default</span></span><br><span class=\"line\">  <span class=\"attr\">vertx:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">vertx-ygo</span></span><br><span class=\"line\">    <span class=\"attr\">options:</span></span><br><span class=\"line\">      <span class=\"attr\">haEnabled:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">      <span class=\"attr\">preferNativeTransport:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"attr\">cors:</span></span><br><span class=\"line\">      <span class=\"attr\">origin:</span> <span class=\"string\">&quot;*&quot;</span></span><br><span class=\"line\">      <span class=\"attr\">allow-credentials:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"attr\">allowed-methods:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">GET</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">POST</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">PUT</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">DELETE</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">PATCH</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">OPTIONS</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">HEAD</span></span><br><span class=\"line\">      <span class=\"attr\">allowed-headers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">Content-Type</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"类、配置\"><a href=\"#类、配置\" class=\"headerlink\" title=\"类、配置\"></a>类、配置</h3><p>定义一个对象,用来装请求的各种参数.</p>\n<p><strong>Request.java</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> org.btr.ygo.web.scan;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> io.vertx.core.http.HttpMethod;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.AccessLevel;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.Data;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.experimental.Accessors;</span><br><span class=\"line\"><span class=\"keyword\">import</span> lombok.experimental.FieldDefaults;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.btr.ygo.web.constant.HttpStatus;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> java.lang.reflect.Method;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.util.Set;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * <span class=\"doctag\">@author</span> &lt;a href=&quot;mailto:1159930219@qq.com&quot;&gt;BornToRain&lt;/a&gt;</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"meta\">@Data</span></span><br><span class=\"line\"><span class=\"meta\">@Accessors(chain = true)</span></span><br><span class=\"line\"><span class=\"meta\">@FieldDefaults(level = AccessLevel.PRIVATE)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Request</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 请求uri路径.</span></span><br><span class=\"line\">  String path;</span><br><span class=\"line\">  HttpMethod httpMethod;</span><br><span class=\"line\">  HttpStatus httpStatus;</span><br><span class=\"line\">  Long timeout;</span><br><span class=\"line\">  <span class=\"comment\">// 对应类中所需要执行的函数</span></span><br><span class=\"line\">  Method method;</span><br><span class=\"line\">  Set&lt;String&gt; consumes;</span><br><span class=\"line\">  Set&lt;String&gt; produces;</span><br><span class=\"line\">  <span class=\"comment\">// 代理类,一般是XxxApi,XxxController,XxxAgent.</span></span><br><span class=\"line\">  Object proxy;</span><br><span class=\"line\">  <span class=\"comment\">// 对应EventBus中的地址.</span></span><br><span class=\"line\">  String addr;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><em>Deck.java</em>追加</p>\n<p><strong>Deck.java</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Deck</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 所有包含@Api注解类</span></span><br><span class=\"line\">  <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> Set&lt;Class&lt;?&gt;&gt; APIS = <span class=\"keyword\">new</span> <span class=\"title class_\">HashSet</span>&lt;&gt;();</span><br><span class=\"line\">  <span class=\"comment\">// 所有的</span></span><br><span class=\"line\">  <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> List&lt;Request&gt; REQUESTS = <span class=\"keyword\">new</span> <span class=\"title class_\">ArrayList</span>&lt;&gt;();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>把<a href=\"https://www.borntorain.com/post/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%92%B8%E6%A1%86%E6%9E%B6(5)-%E4%B8%8EVert.x%E9%9B%86%E6%88%90(%E4%B8%80)\">上一篇</a>中的<em>EventloopHttpActor.java</em>重构一下. 在里面把Router全局配置加上.<br><strong>EventloopHttpActor.java</strong></p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">final</span> <span class=\"keyword\">class</span> <span class=\"title class_\">EventloopHttpActor</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">AbstractVerticle</span> &#123;</span><br><span class=\"line\">  <span class=\"meta\">@Override</span></span><br><span class=\"line\">  <span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title function_\">start</span><span class=\"params\">()</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">    Deck.HTTP_SERVERS.forEach((port, config) -&gt; &#123;</span><br><span class=\"line\">      <span class=\"type\">val</span> <span class=\"variable\">router</span> <span class=\"operator\">=</span> Router.router(vertx);</span><br><span class=\"line\">      configRouter(router);</span><br><span class=\"line\">      server(router, port, config);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"comment\">// router的整体参数配置</span></span><br><span class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">configRouter</span><span class=\"params\">(Router router)</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\">// 集群还是本地存储</span></span><br><span class=\"line\">    <span class=\"type\">val</span> <span class=\"variable\">store</span> <span class=\"operator\">=</span></span><br><span class=\"line\">      vertx.isClustered() ? ClusteredSessionStore.create(vertx) : LocalSessionStore.create(vertx);</span><br><span class=\"line\">    <span class=\"type\">val</span> <span class=\"variable\">cors</span> <span class=\"operator\">=</span> Trunk.&lt;CorsConfig&gt;singleton(CorsConfig.class).read();</span><br><span class=\"line\">    <span class=\"comment\">// POST|PUT请求才接收body,其他不接收解析更快.</span></span><br><span class=\"line\">    router.route().method(HttpMethod.POST).method(HttpMethod.PUT).handler(BodyHandler.create())</span><br><span class=\"line\">      <span class=\"comment\">// 全局默认超时: 5s</span></span><br><span class=\"line\">      .handler(TimeoutHandler.create())</span><br><span class=\"line\">      .handler(ResponseContentTypeHandler.create())</span><br><span class=\"line\">      .handler(SessionHandler.create(store))</span><br><span class=\"line\">      <span class=\"comment\">// 跨域</span></span><br><span class=\"line\">      .handler(CorsHandler.create(cors.getOrigin()).allowCredentials(cors.getAllowCredentials())</span><br><span class=\"line\">        .allowedHeaders(cors.getAllowedHeaders()).allowedMethods(cors.getAllowedMethods()));</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ...</span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n\n<hr>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>这一篇完成了<em>vertx-web</em>的全局配置,使用时会应用到<em>vertx-web</em>下的所有请求.</p>\n","text":"上一篇讲完了与Vert.x集成的整体情况,这一篇开始与vertx-web集成. 这些内容我们主要在web模块中进行开发. Web全局集成web组件下的build...","permalink":"/post/从零开始撸框架(7)-与Vert.x集成 Web篇(一)","photos":[],"count_time":{"symbolsCount":"8k","symbolsTime":"7 mins."},"categories":[{"name":"从零开始","slug":"从零开始","count":8,"path":"api/categories/从零开始.json"}],"tags":[{"name":"Vert.x","slug":"Vert-x","count":8,"path":"api/tags/Vert-x.json"},{"name":"Actor","slug":"Actor","count":8,"path":"api/tags/Actor.json"},{"name":"设计模式","slug":"设计模式","count":8,"path":"api/tags/设计模式.json"},{"name":"Java","slug":"Java","count":9,"path":"api/tags/Java.json"},{"name":"代理模式","slug":"代理模式","count":4,"path":"api/tags/代理模式.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Web%E5%85%A8%E5%B1%80%E9%9B%86%E6%88%90\"><span class=\"toc-text\">Web全局集成</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%B3%A8%E8%A7%A3\"><span class=\"toc-text\">注解</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%AD%97%E6%AE%B5%E7%BA%A7\"><span class=\"toc-text\">字段级</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E7%B1%BB%E7%BA%A7\"><span class=\"toc-text\">类级</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E9%85%8D%E7%BD%AE\"><span class=\"toc-text\">配置</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#cors\"><span class=\"toc-text\">cors</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E9%85%8D%E7%BD%AE%E5%AF%B9%E8%B1%A1\"><span class=\"toc-text\">配置对象</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E9%85%8D%E7%BD%AE%E8%AF%BB%E5%8F%96\"><span class=\"toc-text\">配置读取</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B\"><span class=\"toc-text\">配置示例</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E7%B1%BB%E3%80%81%E9%85%8D%E7%BD%AE\"><span class=\"toc-text\">类、配置</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%80%BB%E7%BB%93\"><span class=\"toc-text\">总结</span></a></li></ol>","author":{"name":"因雨而生","slug":"blog-author","avatar":"/images/avatar.jpg","link":"/","description":"一直没脱离低级趣味的Coder","socials":{"github":"https://github.com/BornToRain","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{"title":"从零开始撸框架(8)-与Vert.x集成 Web篇(二)","uid":"31ebad76ece9cbfbb4b4be8543fa818d","slug":"从零开始撸框架(8)-与Vert.x集成 Web篇(二)","date":"2021-05-12T06:33:24.000Z","updated":"2021-06-28T09:51:53.342Z","comments":true,"path":"api/articles/从零开始撸框架(8)-与Vert.x集成 Web篇(二).json","keywords":["Coder","Scalaer","Javaer"],"cover":"/images/vertxlogo.png","text":"上一篇讲完了全局配置,这一篇我们来讲每个路由的集成. Vert.x原始使用方式样例来自于Vert.x官网 Vert.x配置api接口1234567public ...","permalink":"/post/从零开始撸框架(8)-与Vert.x集成 Web篇(二)","photos":[],"count_time":{"symbolsCount":"25k","symbolsTime":"23 mins."},"categories":[{"name":"从零开始","slug":"从零开始","count":8,"path":"api/categories/从零开始.json"}],"tags":[{"name":"Vert.x","slug":"Vert-x","count":8,"path":"api/tags/Vert-x.json"},{"name":"Actor","slug":"Actor","count":8,"path":"api/tags/Actor.json"},{"name":"设计模式","slug":"设计模式","count":8,"path":"api/tags/设计模式.json"},{"name":"Java","slug":"Java","count":9,"path":"api/tags/Java.json"},{"name":"代理模式","slug":"代理模式","count":4,"path":"api/tags/代理模式.json"}],"author":{"name":"因雨而生","slug":"blog-author","avatar":"/images/avatar.jpg","link":"/","description":"一直没脱离低级趣味的Coder","socials":{"github":"https://github.com/BornToRain","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"从零开始撸框架(6)-与Vert.x集成 基础篇(二)","uid":"a0a429763c9944ec54d86de5e0e4f445","slug":"从零开始撸框架(6)-与Vert.x集成 基础篇(二)","date":"2021-05-07T03:54:00.000Z","updated":"2021-05-10T10:02:35.468Z","comments":true,"path":"api/articles/从零开始撸框架(6)-与Vert.x集成 基础篇(二).json","keywords":["Coder","Scalaer","Javaer"],"cover":"/images/vertxlogo.png","text":"这一章我们来将上一章中的 Verticle 在Vert.x中运行起来. Vert.x原始使用方式样例来自于Vert.x官网 部署Verticle并运行Vert....","permalink":"/post/从零开始撸框架(6)-与Vert.x集成 基础篇(二)","photos":[],"count_time":{"symbolsCount":"4.9k","symbolsTime":"4 mins."},"categories":[{"name":"从零开始","slug":"从零开始","count":8,"path":"api/categories/从零开始.json"}],"tags":[{"name":"Vert.x","slug":"Vert-x","count":8,"path":"api/tags/Vert-x.json"},{"name":"Actor","slug":"Actor","count":8,"path":"api/tags/Actor.json"},{"name":"设计模式","slug":"设计模式","count":8,"path":"api/tags/设计模式.json"},{"name":"Java","slug":"Java","count":9,"path":"api/tags/Java.json"},{"name":"代理模式","slug":"代理模式","count":4,"path":"api/tags/代理模式.json"}],"author":{"name":"因雨而生","slug":"blog-author","avatar":"/images/avatar.jpg","link":"/","description":"一直没脱离低级趣味的Coder","socials":{"github":"https://github.com/BornToRain","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}